<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trawler Catch Manager</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a7cff">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:Arial;
  background:#121212;
  color:white;
  padding:10px;
  font-size:14px;
}
h2{text-align:center;font-size:18px;margin-bottom:10px;}
.section{background:#1f1f1f;padding:10px;border-radius:8px;margin-bottom:10px;}
input,select,button{
  width:100%;padding:8px;margin:4px 0;font-size:13px;border-radius:6px;border:none;
}
button{background:#007bff;color:white;font-weight:bold;}
.deleteBtn{background:#b30000;font-size:12px;padding:4px 6px;width:auto;}
.tableContainer{overflow-x:auto;}
table{
  width:100%;border-collapse:collapse;margin-top:8px;
  background:#1f1f1f;font-size:12px;min-width:700px;
}
th,td{padding:6px;border:1px solid #333;text-align:center;}
.dashboardBox{
  background:#007bff;
  padding:6px;
  border-radius:6px;
  margin:4px 0;
  text-align:center;
  font-weight:bold;
  font-size:13px;
}
</style>
</head>

<body>

<h2>Trawler Catch Manager</h2>

<div class="section">
<h3>Add Crew</h3>
<input id="crewName" placeholder="Crew Name">
<button onclick="addCrew()">Add Crew</button>
<div id="crewList"></div>
</div>

<div class="section">
<h3>Add Catch</h3>

<select id="crewSelect"></select>

<select id="fishType">
<option>Redeye</option>
<option>Sardines</option>
<option>Anchovies</option>
</select>

<select id="factory">
<option>Westpoint</option>
<option>Amawandle</option>
<option>Stompneus</option>
</select>

<input type="number" id="tonnage" placeholder="Tonnage">
<input type="date" id="date">

<button onclick="addCatch()">Add Catch</button>
</div>

<div class="section">
<h3>Filters & Reports</h3>

<input type="month" id="monthFilter" onchange="loadTable()">
<input type="text" id="searchCrew" placeholder="Search Crew" onkeyup="loadTable()">

<h4>Date Range Report</h4>
<input type="date" id="startDate">
<input type="date" id="endDate">
<button onclick="exportDateRangeReport()">Generate Date Range Report</button>

<br><br>

<button onclick="exportMonthlyReport()">Generate Professional Monthly Report</button>
</div>

<div class="section">
<h3>Factory Totals (Current View)</h3>
<div id="factoryTotalsDisplay"></div>
</div>

<div class="section">
<h3>Catch Records</h3>
<div class="tableContainer">
<table id="catchTable">
<thead>
<tr>
<th>Crew</th>
<th>Fish</th>
<th>Factory</th>
<th>Tons</th>
<th>Date</th>
<th>Delete</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
</div>

<script>

let crew = JSON.parse(localStorage.getItem("crew")) || [];
let catches = JSON.parse(localStorage.getItem("catches")) || [];

function saveData(){
  localStorage.setItem("crew", JSON.stringify(crew));
  localStorage.setItem("catches", JSON.stringify(catches));
}

function addCrew(){
  const name=document.getElementById("crewName").value;
  if(name){
    crew.push(name);
    document.getElementById("crewName").value="";
    saveData();
    loadCrew();
  }
}

function deleteCrew(index){
  crew.splice(index,1);
  saveData();
  loadCrew();
}

function loadCrew(){
  const select=document.getElementById("crewSelect");
  const crewList=document.getElementById("crewList");
  select.innerHTML="";
  crewList.innerHTML="";

  crew.forEach((member,index)=>{
    const option=document.createElement("option");
    option.text=member;
    select.add(option);

    const div=document.createElement("div");
    div.innerHTML = member +
      ' <button class="deleteBtn" onclick="deleteCrew('+index+')">Remove</button>';
    crewList.appendChild(div);
  });
}

function addCatch(){
  const crewMember=document.getElementById("crewSelect").value;
  const fish=document.getElementById("fishType").value;
  const factory=document.getElementById("factory").value;
  const tonnage=parseFloat(document.getElementById("tonnage").value);
  const date=document.getElementById("date").value;

  if(crewMember && tonnage && date){
    catches.push({crewMember,fish,factory,tonnage,date});
    saveData();
    document.getElementById("tonnage").value="";
    loadTable();
  }
}

function loadTable(){

  const monthFilter=document.getElementById("monthFilter").value;
  const searchCrew=document.getElementById("searchCrew").value.toLowerCase();
  const tbody=document.querySelector("#catchTable tbody");
  tbody.innerHTML="";

  let filtered=catches.filter(item=>{
    let matchMonth=!monthFilter || item.date.startsWith(monthFilter);
    let matchCrew=!searchCrew || item.crewMember.toLowerCase().includes(searchCrew);
    return matchMonth && matchCrew;
  });

  filtered.forEach((item,index)=>{
    const row=tbody.insertRow();
    row.innerHTML=`
      <td>${item.crewMember}</td>
      <td>${item.fish}</td>
      <td>${item.factory}</td>
      <td>${item.tonnage}</td>
      <td>${item.date}</td>
      <td><button class="deleteBtn" onclick="deleteCatch(${index})">X</button></td>
    `;
  });

  updateFactoryTotals(filtered);
}

function updateFactoryTotals(filtered){

  let totals={
    "Westpoint":0,
    "Amawandle":0,
    "Stompneus":0
  };

  let countedTrips = new Set();

  filtered.forEach(item=>{
    let tripKey = item.date + "_" + item.factory + "_" + item.fish + "_" + item.tonnage;

    if(!countedTrips.has(tripKey)){
      totals[item.factory] += item.tonnage;
      countedTrips.add(tripKey);
    }
  });

  const display=document.getElementById("factoryTotalsDisplay");
  display.innerHTML="";

  for(let factory in totals){
    const div=document.createElement("div");
    div.className="dashboardBox";
    div.textContent=factory+": "+totals[factory].toFixed(2)+" tons";
    display.appendChild(div);
  }
}

function deleteCatch(index){
  catches.splice(index,1);
  saveData();
  loadTable();
}

/* DATE RANGE REPORT */

function exportDateRangeReport(){
  const start=document.getElementById("startDate").value;
  const end=document.getElementById("endDate").value;
  if(!start || !end){ alert("Select start and end date."); return; }

  let filtered=catches.filter(item=>item.date>=start && item.date<=end);
  if(filtered.length===0){ alert("No records in selected range."); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let crewTotals={}, factoryTotals={};
  let countedTrips = new Set();

  filtered.forEach(item=>{
    crewTotals[item.crewMember]=(crewTotals[item.crewMember]||0)+item.tonnage;

    let tripKey = item.date + "_" + item.factory + "_" + item.fish + "_" + item.tonnage;

    if(!countedTrips.has(tripKey)){
      factoryTotals[item.factory]=(factoryTotals[item.factory]||0)+item.tonnage;
      countedTrips.add(tripKey);
    }
  });

  let y=20;
  doc.setFontSize(18);
  doc.text("TRAWLER DATE RANGE REPORT",20,y);
  y+=10;
  doc.text("From: "+start+"  To: "+end,20,y);
  y+=10;

  doc.text("TOTAL PER CREW",20,y);
  y+=8;
  for(let c in crewTotals){ doc.text(c+": "+crewTotals[c].toFixed(2)+" tons",25,y); y+=6; }

  y+=6;
  doc.text("TOTAL PER FACTORY",20,y);
  y+=8;
  for(let f in factoryTotals){ doc.text(f+": "+factoryTotals[f].toFixed(2)+" tons",25,y); y+=6; }

  doc.save("Date_Range_Report_"+start+"_to_"+end+".pdf");
}

/* MONTHLY REPORT */

function exportMonthlyReport(){
  let month=document.getElementById("monthFilter").value;
  if(!month){ alert("Please select a month first."); return; }

  let filtered=catches.filter(item=>item.date.startsWith(month));
  if(filtered.length===0){ alert("No records found for "+month); return; }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let crewTotals={}, factoryTotals={};
  let countedTrips = new Set();

  filtered.forEach(item=>{
    crewTotals[item.crewMember]=(crewTotals[item.crewMember]||0)+item.tonnage;

    let tripKey = item.date + "_" + item.factory + "_" + item.fish + "_" + item.tonnage;

    if(!countedTrips.has(tripKey)){
      factoryTotals[item.factory]=(factoryTotals[item.factory]||0)+item.tonnage;
      countedTrips.add(tripKey);
    }
  });

  let y=20;
  doc.setFontSize(18);
  doc.text("MONTHLY REPORT - "+month,20,y);
  y+=10;

  doc.text("CREW TOTALS",20,y);
  y+=8;
  for(let c in crewTotals){ doc.text(c+": "+crewTotals[c].toFixed(2)+" tons",25,y); y+=6; }

  y+=6;
  doc.text("FACTORY TOTALS",20,y);
  y+=8;
  for(let f in factoryTotals){ doc.text(f+": "+factoryTotals[f].toFixed(2)+" tons",25,y); y+=6; }

  doc.save("Professional_Monthly_Report_"+month+".pdf");
}

loadCrew();
loadTable();

</script>

</body>
</html>
